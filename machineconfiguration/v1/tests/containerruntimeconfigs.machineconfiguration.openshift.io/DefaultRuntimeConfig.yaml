apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "ContainerRuntimeConfig"
crdName: containerruntimeconfigs.machineconfiguration.openshift.io
tests:
  onCreate:
    - name: Should fail if invalid ContainerRuntimeConfig is provided
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1
        kind: ContainerRuntimeConfig
        spec:  
          containerRuntimeConfig:
            defaultRuntime: docker
      expectedError: "Unsupported value: \"docker\": supported values: \"crun\", \"runc\", \"\""
    - name: Should be able to set crun in ContainerRuntimeConfig
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1
        kind: ContainerRuntimeConfig
        spec:  
          containerRuntimeConfig:
            defaultRuntime: crun
      expected: |
        apiVersion: machineconfiguration.openshift.io/v1
        kind: ContainerRuntimeConfig
        spec: 
          containerRuntimeConfig:
            defaultRuntime: crun
    - name: Should be able to set runc in ContainerRuntimeConfig
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1
        kind: ContainerRuntimeConfig
        spec:  
          containerRuntimeConfig:
            defaultRuntime: runc
      expected: |
        apiVersion: machineconfiguration.openshift.io/v1
        kind: ContainerRuntimeConfig
        spec: 
          containerRuntimeConfig:
            defaultRuntime: runc
    - name: Should be able to set other parameters
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1
        kind: ContainerRuntimeConfig
        spec:
          containerRuntimeConfig:
            defaultRuntime: runc
            logLevel: info
      expected: |
        apiVersion: machineconfiguration.openshift.io/v1
        kind: ContainerRuntimeConfig
        spec:
          containerRuntimeConfig:
            defaultRuntime: runc
            logLevel: info
  onUpdate:
    - name: Should be able to update other parameters with invalid defaultRuntime
      initialCRDPatches:
        - op: remove
          path: /spec/versions/0/schema/openAPIV3Schema/properties/spec/properties/containerRuntimeConfig/properties/defaultRuntime/enum
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1
        kind: ContainerRuntimeConfig
        spec:
          containerRuntimeConfig:
            defaultRuntime: docker
            logLevel: fatal
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1
        kind: ContainerRuntimeConfig
        spec:
          containerRuntimeConfig:
            defaultRuntime: docker
            logLevel: info
      expected: |
        apiVersion: machineconfiguration.openshift.io/v1
        kind: ContainerRuntimeConfig
        spec:
          containerRuntimeConfig:
            defaultRuntime: docker
            logLevel: info
